<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>生物記憶卡</title>
<style>
  :root{ /* 預設主題：深紫色 */
    --primary:#5a4fcf;
    --primary-2:#8f7ce8;
    --bg-1:#667eea;
    --bg-2:#764ba2;
    --card-1:#a18cd1;
    --card-2:#fbc2eb;
    --front-1:#c3aed6;
    --front-2:#f7d6e0;
    --back-1:#6a3093;
    --back-2:#a044ff;
    --text:#2c2c54;
    --text-inv:#f0e9ff;
    --shadow-1: rgba(90, 79, 207, 0.7);
    --shadow-2: rgba(143, 124, 232, 0.9);
  }
  /* --- 新增：定義多套顏色主題 --- */
  :root.theme-ocean-blue { /* 主題2：海洋藍 */
    --primary: #0077b6; --primary-2: #0096c7; --bg-1: #005f73; --bg-2: #0a9396;
    --card-1: #94d2bd; --card-2: #e9d8a6; --front-1: #e9f5db; --front-2: #cfe8e0;
    --back-1: #001219; --back-2: #005f73; --text: #001219; --text-inv: #e9f5db;
    --shadow-1: rgba(0, 119, 182, 0.7); --shadow-2: rgba(0, 150, 199, 0.9);
  }
  :root.theme-sunset-glow { /* 主題3：日落霞光 */
    --primary: #e76f51; --primary-2: #f4a261; --bg-1: #e15f41; --bg-2: #e76f51;
    --card-1: #f4a261; --card-2: #e9c46a; --front-1: #fff8f0; --front-2: #fefae0;
    --back-1: #d62828; --back-2: #f77f00; --text: #264653; --text-inv: #ffffff;
    --shadow-1: rgba(231, 111, 81, 0.7); --shadow-2: rgba(244, 162, 97, 0.9);
  }
  :root.theme-forest-green { /* 主題4：森林綠 */
    --primary: #2d6a4f; --primary-2: #40916c; --bg-1: #1b4332; --bg-2: #2d6a4f;
    --card-1: #74c69d; --card-2: #b7e4c7; --front-1: #d8f3dc; --front-2: #ffffff;
    --back-1: #081c15; --back-2: #1b4332; --text: #081c15; --text-inv: #d8f3dc;
    --shadow-1: rgba(45, 106, 79, 0.7); --shadow-2: rgba(64, 145, 108, 0.9);
  }
  /* --- 主題定義結束 --- */

  *{box-sizing:border-box}
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
    margin: 0; padding: 0;
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    color: #f0f0f0;
    transition: background 0.5s ease;
  }
  header {
  /* 大部分樣式不變，主要是修改排版方式 */
  background: linear-gradient(90deg, var(--primary), var(--primary-2));
  width: 100%;
  padding: 1.1rem 1rem;
  font-size: 1.2rem;
  font-weight: 700;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  position: sticky; top: 0; z-index: 10;
  transition: background 0.5s ease;

  /* 以下是修改和新增的部分 */
  display: flex;
  justify-content: center; /* 讓內容水平置中 */
  align-items: center;    /* 讓內容垂直置中 */
  position: relative;     /* 為了讓返回按鈕能定位 */
}
.back-link {
  position: absolute; /* 絕對定位，讓它脫離正常的排版流 */
  left: 15px;         /* 定位在 header 左邊 15px 的位置 */
  top: 50%;           /* 垂直置中 */
  transform: translateY(-50%); /* 確保精確垂直置中 */

  color: var(--text-inv);
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  background: rgba(255, 255, 255, 0.15);
  padding: 8px 12px;
  border-radius: 8px;
  transition: background 0.2s;
}

.back-link:hover {
  background: rgba(255, 255, 255, 0.3);
}
  main {
    flex: 1; width: 100%; max-width: 520px;
    padding: 1rem 1rem 1.5rem;
    display: flex; flex-direction: column; align-items: center; gap: .75rem;
  }
  .chapters {
    width: 100%; display: flex; gap: .5rem;
    overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: .25rem;
  }
  .chapters::-webkit-scrollbar{height:6px}
  .chapters::-webkit-scrollbar-thumb{background:rgba(255,255,255,.3);border-radius:6px}
  .tab {
    white-space: nowrap; background: rgba(255,255,255,0.15); color: #fff;
    border: 1px solid rgba(255,255,255,0.25); padding: .45rem .75rem;
    border-radius: 999px; cursor: pointer; transition: all .25s; font-size: .95rem;
  }
  .tab:hover { background: rgba(255,255,255,0.25); }
  .tab.active {
    background: #ffce6b; color: #2b2b2b; border-color: #ffce6b;
    box-shadow: 0 2px 10px rgba(255,206,107,0.45);
  }
  #flashcardPage {
    flex-direction: column; align-items: center; display: flex; width: 100%;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .card-container {
    perspective: 1000px; width: 100%; height: 240px; outline: none;
    animation: fadeIn 0.4s ease-out;
  }
  .card {
    width: 100%; height: 240px; position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s, background 0.5s ease;
    cursor: pointer; border-radius: 16px;
    background: linear-gradient(135deg, var(--card-1), var(--card-2));
    box-shadow: 0 8px 20px rgba(0,0,0,0.3); color: var(--text);
    display: flex; justify-content: center; align-items: center;
    padding: 1.25rem; font-size: 1.05rem; line-height: 1.45;
    user-select: none; text-align: left; white-space: pre-wrap;
  }
  .card.flipped { transform: rotateY(180deg); }
  .card-face {
    position: absolute; width: 100%; height: 100%; border-radius: 16px;
    backface-visibility: hidden; display: flex; justify-content: center;
    align-items: flex-start; padding: 1.25rem; box-sizing: border-box;
    overflow-y: auto;
    transition: background 0.5s ease, color 0.5s ease;
  }
  .card-front { background: linear-gradient(135deg, var(--front-1), var(--front-2)); color: var(--text); }
  .card-back { transform: rotateY(180deg); background: linear-gradient(135deg, var(--back-1), var(--back-2)); color: var(--text-inv); }
  #cardNumber { margin-top: 0.4rem; font-size: 0.9rem; color: #e9e6ff; text-align: center; }
  .footer { margin-top: 1rem; width: 100%; display: flex; flex-direction: column; align-items: center; gap: .4rem; }
  .button-row { display: flex; justify-content: center; gap: .6rem; flex-wrap: wrap; width: 100%; }
  button {
    background: var(--primary); border: none; color: white;
    padding: 0.5rem 0.9rem; font-size: 1rem; border-radius: 10px; cursor: pointer;
    transition: background 0.25s, transform .05s, box-shadow 0.25s;
    min-width: 88px;
    box-shadow: 0 4px 10px var(--shadow-1);
  }
  button:hover:not(:disabled) {
    background: var(--primary-2); box-shadow: 0 6px 14px var(--shadow-2);
  }
  button:active:not(:disabled){ transform: translateY(1px); }
  button:disabled { background: #a0aabe; cursor: default; box-shadow: none; color: #eee; }
  #summaryBlock {
    margin-top: 0.9rem; background: rgba(0,0,0,0.35); padding: 1rem; border-radius: 12px;
    max-height: 340px; overflow-y: auto; width: 100%; text-align: left;
    transition: all 0.4s ease-out; transform: translateY(20px); opacity: 0;
  }
  #summaryBlock:not([hidden]) { transform: translateY(0); opacity: 1; }
  #summaryBlock h3 { margin: 0 0 .5rem 0; color: var(--text-inv); font-size: 1.05rem; }
  #summaryBlock .summary-item { margin-bottom: .8rem; background: rgba(255,255,255,0.08); padding: .6rem .7rem; border-radius: 10px; }
  #summaryBlock .summary-item p { margin: 0.2rem 0; }
  .toolbar { width: 100%; display: flex; justify-content: space-between; align-items: center; gap: .6rem; flex-wrap: wrap; }
  .pill { font-size: .9rem; color: #fff; background: rgba(255,255,255,.15); padding: .35rem .6rem; border-radius: 999px; }
  @media (max-width: 520px) {
    .card { height: 210px; font-size: 1rem; padding: 1rem; }
    .card-face { padding: 1rem; }
  }
</style>
</head>
<body>
<header>
  <a href="index.html" class="back-link">🔙 返回目錄</a>
  <span id="headerTitle">CH1 生物學入門</span>
</header>
<main>
  <nav class="chapters" aria-label="章節切換">
    <button class="tab active" data-chapter="CH15" aria-pressed="true">CH15</button>
    <button class="tab" data-chapter="CH16" aria-pressed="false">CH16</button>
    <button class="tab" data-chapter="CH17" aria-pressed="false">CH17</button>
    <button class="tab" data-chapter="CH18" aria-pressed="false">CH18</button>
  </nav>
  <div class="toolbar">
    <span id="chapterInfo" class="pill">目前章節：CH11</span>
    <button id="themeBtn" aria-label="切換主題" style="min-width: auto; padding: 0.4rem 0.7rem;">🎨 切換主題</button>
    <span class="pill">操作提示：點卡片或按空白鍵翻轉</span>
  </div>
  <section id="flashcardPage" aria-live="polite" aria-atomic="true">
    <div class="card-container" tabindex="0" aria-label="抽認卡，點擊或按空白鍵翻轉">
      <div id="card" class="card" role="button" aria-pressed="false" tabindex="0">
        <div id="cardFront" class="card-face card-front"></div>
        <div id="cardBack" class="card-face card-back"></div>
      </div>
      <div id="cardNumber" aria-live="polite" aria-atomic="true"></div>
    </div>
    <div class="footer">
      <div class="button-row" id="firstRow">
        <button id="flipBtn" aria-label="翻轉卡片">🔄 翻轉</button>
        <button id="hardBtn" aria-label="困難">🤔 困難</button>
        <button id="mediumBtn" aria-label="一般">🙂 一般</button>
        <button id="easyBtn" aria-label="容易">😄 容易</button>
      </div>
      <div class="button-row" id="secondRow">
        <button id="prevBtn" aria-label="上一題" disabled>⬅️ 上一題</button>
        <button id="summaryBtn" aria-label="困難題目小結">📝 困難小結</button>
      </div>
    </div>
    <div id="summaryBlock" aria-live="polite" aria-atomic="true" hidden></div>
  </section>
</main>
<script>
const PROGRESS_KEY = 'flashcardProgress_15-18'; // <-- 每個檔案都不同！
const SETTINGS_KEY = 'flashcardSettings';     // <-- 所有檔案都相同！
// =================================================
// Local Storage 功能區塊
// =================================================

// 【用這段新程式碼】替換掉舊的 saveProgress 和 loadProgressAndSettings 函式

// 函式：儲存所有進度到 localStorage
function saveProgress() {
  // 1. 儲存【專屬進度】
  const progressData = {
    stateByChapter: stateByChapter,
    currentChapterId: currentChapterId
  };
  localStorage.setItem(PROGRESS_KEY, JSON.stringify(progressData));

  // 2. 儲存【共用設定】
  const settingsData = {
    currentThemeIndex: currentThemeIndex
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsData));
}

// 函式：從 localStorage 讀取並應用所有進度
function loadProgressAndSettings() {
  // 1. 讀取【專屬進度】
  const progressDataJSON = localStorage.getItem(PROGRESS_KEY);
  if (progressDataJSON) {
    try {
      const progressData = JSON.parse(progressDataJSON);
      if (progressData.stateByChapter) {
        Object.assign(stateByChapter, progressData.stateByChapter);

        // 【新增的關鍵修正】：強制重設所有課題的暫時狀態
        // 無論讀取到什麼，都確保 flipped 和 flipping 是 false
        for (const chapterId in stateByChapter) {
          if (stateByChapter[chapterId]) {
            stateByChapter[chapterId].flipped = false;
            stateByChapter[chapterId].flipping = false; // <-- 【補上這最重要的一行】
          }
        }
      }
      
      // 安全檢查：確認讀取到的章節 ID 是否存在於當前檔案中
      if (progressData.currentChapterId && chapters.some(c => c.id === progressData.currentChapterId)) {
        currentChapterId = progressData.currentChapterId;
      }
    } catch (e) {
      console.error("讀取進度資料時出錯:", e);
    }
  }
  
  // 2. 讀取【共用設定】
  const settingsDataJSON = localStorage.getItem(SETTINGS_KEY);
  if (settingsDataJSON) {
    try {
      const settingsData = JSON.parse(settingsDataJSON);
      if (typeof settingsData.currentThemeIndex !== 'undefined') {
        currentThemeIndex = settingsData.currentThemeIndex;
        docElem.className = themes[currentThemeIndex];
      }
    } catch (e) {
      console.error("讀取設定資料時出錯:", e);
    }
  }
}
// =================================================
// Local Storage 功能區塊結束
// =================================================
  // 章節資料定義
  const chapters = [
    // ... (所有 chapters 的資料和之前一樣，此處省略以節省篇幅) ...
    {
       id: "CH15",
      title: "CH15 環境狀況的探測",
      flashcards: [
      { question: "什麼是生物的感應性？", answer: "生物能探測環境刺激並作出適當反應的能力。\n\n解釋： 感應性讓生物能適應環境變化，維持生存。" },
      { question: "感應性包括哪三個主要部分？", answer: "感受器、控制中心、效應器。\n\n解釋： 感受器偵測刺激，控制中心處理訊息，效應器作出反應。" },
      { question: "眼睛中哪個部位負責聚焦光線？", answer: "角膜、水狀液、玻璃狀液和晶體。\n\n解釋： 角膜主要折射光線，晶體可調節厚度以精確聚焦。" },
      { question: "為什麼晶體沒有血管？", answer: "避免阻礙光線通過並保持透明。\n\n解釋： 血管會阻擋光線，影響視覺清晰度。" },
      { question: "視網膜包括哪些感光細胞？功能是什麼？", answer: "視桿細胞（弱光黑白視覺）、視錐細胞（色覺）。\n\n解釋： 視桿細胞負責黑白視覺，視錐細胞負責色覺。" },
      { question: "什麼是眼睛的盲點？", answer: "沒有感光細胞，無法形成視覺的區域。\n\n解釋： 盲點是視神經離開眼球的位置，縱使有影像形亦無法被感知。" },
      { question: "黃點與盲點有何不同？", answer: "黃點感光細胞密集，是視覺最清晰區，盲點無感光細胞。\n\n解釋： 黃點負責精細視覺，盲點無法感光。" },
      { question: "光線如何在眼睛中形成視覺？", answer: "光線被折射聚焦於視網膜，感光細胞受刺激產生神經脈衝，經視神經傳至大腦，大腦產生視覺。\n\n解釋： 大腦視覺中心形成視覺。" },
      { question: "眼睛如何調節進入光量？", answer: "在強光下，虹膜的環肌收縮，放射肌放鬆。瞳孔因而縮小，減少進入眼球的光量。在弱光下，虹膜的環肌放鬆，放射肌收縮。瞳孔因而擴張，讓更多光線進入眼球。" },
      { question: "為什麼瞳孔不能收縮或放鬆？", answer: "瞳孔是孔洞，虹膜肌肉收縮或放鬆改變瞳孔大小。\n\n解釋： 肌肉才有收縮功能。" },
      { question: "觀看遠物時晶體有何變化？", answer: "睫狀肌放鬆，懸韌帶張力增加，晶體變薄。\n\n解釋： 藉由變薄減少折射力，聚焦遠距物體。" },
      { question: "觀看近物時晶體有何變化？", answer: "睫狀肌收縮，懸韌帶張力減少，晶體變厚。\n\n解釋： 變厚增加折射力，聚焦近距物體。" },
      { question: "近視的成因及其矯正方法？", answer: "眼球過長或晶體過厚，影像聚焦於視網膜前；用凹透鏡矯正。" },
      { question: "遠視的成因及其矯正方法？", answer: "眼球過短或晶體過薄，影像聚焦於視網膜後；用凸透鏡矯正。" },
      { question: "色盲是什麼？其原因為何？", answer: "不能分辨某些顏色，因部分或全部視錐細胞有缺陷。\n\n解釋： 基因遺傳導致部分視錐細胞缺失或功能異常。" },
      { question: "什麼是植物的向性？", answer: "植物對［單側刺激］作出的［方向性］［生長］運動。\n\n解釋： 如向光性幫助植物適應環境。" },
      { question: "生長素在植物中有什麼作用？", answer: "促進細胞延長，調控生長。\n\n解釋： 生長素分布不均引起植物彎曲。" },
      { question: "生長素如何影響根和枝條的生長？", answer: "高濃度促進枝條生長，抑制根生長。\n\n解釋： 生長素濃度不同，效果相反。" },
      { question: "生長素能否通過雲母片？", answer: "不能。故此，實驗很常使用雲母片阻隔生長素移動。" },
      { question: "胚芽鞘為什麼常用於研究向性？", answer: "生長快，易觀察彎曲。" },
      { question: "光線如何影響胚芽鞘中生長素的分布？", answer: "光使生長素由向光側移向背光側，造成彎曲。\n\n解釋： 生長素分布不均促進一側細胞延長。" },
      { question: "內耳中感覺毛細胞的功能是什麼？", answer: "探測聲波振動，發出神經脈衝。" },
      { question: "聽小骨的作用是什麼？", answer: "放大鼓膜振動並傳遞至內耳。\n\n解釋： 增強聲波效率。" },
      { question: "半規管的功能是什麼？", answer: "探測頭部運動，維持平衡。\n\n解釋： 感受角速度變化。" },
      { question: "為什麼耳咽管對飛行中耳朵不適的關係十分密切？", answer: "耳咽管平衡中耳與外界氣壓。\n\n解釋： 避免耳膜在高空向外鼓起。" },
      { question: "感應性對生物的生存有何重要性？", answer: "感應性是指生物探測環境變化（刺激）並作出反應的能力。這對生物的生存至關重要，因為它有助生物獲取食物（例如蝴蝶循花蜜氣味飛向花朵）、尋找配偶（例如雌性孔雀被雄性孔雀的尾羽吸引）及逃避危險（例如動物探測到捕食者時逃跑）。" },
      { question: "感應性涉及哪三個主要部分？", answer: "感應性是由感受器、協調系統和效應器共同負責的。感受器負責偵測刺激並轉化為神經脈衝；協調系統（如神經系統和內分泌系統）負責處理信息並發出指令；效應器（如肌肉或腺體）則執行反應。" },
      { question: "眼睫毛和眼眉毛在眼睛保護方面各有哪些主要功能？", answer: "眼睫毛位於眼瞼邊緣，其主要功能是阻止污垢、灰塵或昆蟲進入眼睛；而眼眉毛位於眼睛上方，其主要功能是防止汗水或雨水流入眼睛，避免刺激。" },
      { question: "「近視」的成因通常是什麼？", answer: "主要成因通常是眼球過長（導致視網膜距離晶狀體太遠）或晶狀體太厚。這會導致來自遠處的平行光線在到達視網膜之前就聚焦，使遠處物體成像模糊。" },
      { question: "瞳孔的功能是什麼？", answer: "瞳孔是虹膜中央的開口，它本身不是一個結構，而是光線進入眼睛的通道。其大小受到虹膜肌肉的控制，主要功能是調節進入眼睛的光線量：在強光下縮小以減少光線，保護視網膜；在弱光下擴大以增加光線，便於看清物體。" },
      { question: "虹膜的功能是什麼？", answer: "虹膜是眼球內有顏色的環狀部分，位於角膜後面，圍繞著瞳孔。它含有兩組肌肉（環形肌和放射狀肌）。虹膜的主要功能是控制瞳孔的大小，從而精確調節進入眼睛的光線量。" },
      { question: "晶體在視覺中扮演什麼角色？", answer: "晶體是一個透明的雙凸透鏡，位於虹膜和瞳孔後方。它通過睫狀體和懸韌帶的調節，改變自身的厚度，以聚焦光線在視網膜上。這個過程稱為視覺調節。" },
      { question: "視網膜的功能是什麼？", answer: "視網膜是眼球後方內壁上的一層感光組織，含有視桿細胞和視錐細胞這兩種感光細胞。它的主要功能是將接收到的光刺激轉化為神經脈衝，然後這些脈衝會經由視神經傳遞到大腦，形成視覺。" },
      { question: "視桿細胞和視錐細胞在功能上有何主要區別？", answer: "這是常見的混淆點。視桿細胞：數量多，對光線高度敏感，主要負責在昏暗光線下感知物體（夜間視覺），但不能分辨顏色，只能看到黑白和灰階影像。視錐細胞：數量相對較少，需要較強的光線才能刺激，主要負責在強光下分辨顏色（日間和顏色視覺）和提供精細的中央視力。人眼有三種類型的視錐細胞，分別對紅、綠、藍光敏感。" },
      { question: "盲點的特性和位置是什麼？", answer: "盲點是視網膜上視神經纖維和血管離開眼球的部位，也稱為視神經盤。由於此處沒有任何感光細胞（視桿或視錐細胞），因此當光線聚焦到這個區域時，我們無法感知光線，形成一個視覺上的盲區。通常我們不會注意到它的存在，因為大腦會自動填補這個空缺，且雙眼視覺也能互相彌補。" },
      { question: "脈絡膜的功能是什麼？", answer: "脈絡膜是位於鞏膜和視網膜之間的一層深色膜層。它含有豐富的血管，主要功能是為視網膜等眼部組織提供營養和氧氣。此外，其深色色素能吸收多餘的光線，防止光線在眼球內部反射，使影像清晰。" },
      { question: "玻璃狀液的功能是什麼？", answer: "玻璃狀液（或稱玻璃體）是一種透明的膠狀物質，填充在晶狀體與視網膜之間的大部分眼球空間。它的主要功能是維持眼球的形狀，並有助於折射光線，使其能清晰地傳遞到視網膜上。" },
      { question: "神經系統中的「感受器」和「效應器」有何區別？", answer: "感受器：是分佈在感覺器官（如眼睛、耳朵、皮膚）或體內器官中的感覺細胞。它們的功能是偵測特定的刺激（如光、聲、壓力、溫度等），並將這些刺激的能量轉化為神經脈衝。效應器：是身體對刺激作出反應的部位，通常是肌肉或腺體。" },
      { question: "瞳孔對光反射的意義是什麼？", answer: "瞳孔對光反射是一種不自主的神經反射。當眼睛受到強光刺激時，瞳孔會縮小；當光線減弱時，瞳孔會擴大。其主要意義在於護視網膜：在強光下縮小瞳孔，減少進入眼睛的光線量，防止過強光線損害視網膜敏感的感光細胞。" },
      { question: "耳朵中的耳廓有什麼功能？", answer: "耳廓收集聲波並引導其進入聽道。" },
      { question: "聽覺的形成過程是什麼？", answer: "聲波振動鼓膜，經聽小骨傳至內耳，形成聽覺信號。" },
      { question: "生長素如何影響植物的向光性？", answer: "生長素移向背光側，促進該側生長，使植物彎向光。" },
      { question: "耳朵中的聽小骨有什麼作用？", answer: "聽小骨放大鼓膜振動並傳至內耳。" },
      { question: "內耳中的耳蝸負責什麼？", answer: "耳蝸將振動轉為神經脈衝，形成聽覺。" },
      { question: "為什麼在暗處難以分辨顏色？", answer: "暗處視錐細胞不活躍，無法辨識顏色。" },
      { question: "晶體由什麼控制其弧度？", answer: "晶體弧度由環狀睫狀肌控制。" },
      { question: "視神經的功用是什麼？", answer: "視神經將視網膜信號傳至大腦。" }
    ]
    },
    {
   id: "CH16",
      title: "CH16 人體的協調",
      flashcards: [
      { question: "運動神經元的功能是什麼？", answer: "將神經脈衝從中樞神經系統傳遞到效應器（肌肉和腺體）。\n\n解釋: 使肌肉收縮產生動作。" },
      { question: "為什麼運動神經元疾病會否影響感覺功能？", answer: "不會，感覺神經元和運動神經元是不同的神經細胞。運動神經元疾病只損傷運動神經元，感覺神經元仍正常傳遞感覺信號。" },
      { question: "人體的中樞神經系統包括什麼？", answer: "中樞神經系統由腦和脊髓組成。\n\n解釋: 是神經系統的核心部分。" },
      { question: "神經元的主要結構有哪些？", answer: "包括細胞體、樹突、軸突、髓鞘和突觸小體。\n\n解釋: 分別負責接收、傳遞與發送神經脈衝。" },
      { question: "髓鞘有什麼作用？", answer: "髓鞘包裹神經纖維，絕緣並防止神經脈衝錯亂傳遞。同時加快傳遞速度。" },
      { question: "感覺神經元、運動神經元和中間神經元的差異？", answer: "感覺神經元將信號傳至中樞神經系統；運動神經元將信號從中樞傳至效應器；中間神經元連接感覺與運動神經元。\n\n解釋: 三者在信息傳遞路徑中各司其職。" },
      { question: "神經脈衝是如何跨越突觸的？", answer: "軸突末端釋放神經遞質，擴散過突觸間隙，再與下一神經元受體結合。\n\n解釋: 誘發神經脈衝。" },
      { question: "突觸為什麼能確保神經脈衝單方向傳遞？", answer: "因為只有軸突末端有突觸小泡釋放神經遞質，而受體只存在於下一神經元的樹突或細胞體。\n\n解釋: 這種結構確保了信息的單向流動。" },
      { question: "什麼是反射弧？", answer: "反射動作中神經脈衝傳遞的完整路徑。\n\n解釋: 包括感受器、感覺神經元、中間神經元（某些反射不含）、運動神經元及效應器。" },
      { question: "退縮反射涉及哪些神經元？", answer: "感覺神經元、中間神經元和運動神經元。\n\n解釋: 共同作用，使身體快速縮回避免傷害。" },
      { question: "為什麼縮手後才感覺到痛？", answer: "因為痛覺信號傳往大腦的路徑較長且涉及較多突觸，速度較慢。反射動作通過較短的反射弧快速完成。" },
      { question: "膝躍反射涉及哪種神經元？", answer: "膝蓋反射不涉及中間神經元。因為感覺神經元直接與運動神經元連接。" },
      { question: "大腦皮層的三個主要功能區是什麼？分別有什麼功能？", answer: "感覺區（接受與解讀感覺）、運動區（控制隨意動作）、聯合區（整合信息與決策）。" },
      { question: "小腦的主要功能是什麼？", answer: "協調肌肉活動，保持身體姿勢與平衡。\n\n解釋: 確保動作流暢。" },
      { question: "延髓控制哪些重要功能？", answer: "控制不隨意動作如呼吸、心跳。並為多種反射提供反射中樞。" },
      { question: "隨意動作和反射動作的主要分別是什麼？", answer: "隨意動作受大腦意識控制，無固定反應模式；反射動作不受意識控制，有固定反應模式。反射動作反應快速。" },
      { question: "內分泌系統由什麼組成？", answer: "由多個內分泌腺組成。分泌激素調節身體功能。" },
      { question: "激素如何作用於目標器官？", answer: "激素通過血液運送，與目標細胞膜上的特定受體結合。以調控細胞活動。" },
      { question: "激素協調與神經協調有何不同？", answer: "激素協調速度慢但作用持久且範圍廣；神經協調速度快但作用短暫且局部。" },
      { question: "為什麼反射動作反應速度快？", answer: "反射動作經過較短的反射弧，不需要大腦參與，減少傳遞時間。" },
      { question: "內分泌腺和外分泌腺的主要區別是什麼？", answer: "內分泌腺無管道，激素直接釋入血液；外分泌腺有管道，分泌物排出體外或腔內。\n\n解釋: 這是腺體分泌方式的根本區別。" },
      { question: "為什麼神經元軸突末端有大量線粒體？", answer: "因為需要大量能量產生神經遞質和釋放神經遞質。\n\n解釋: 線粒體是細胞的能量工廠。" },
      { question: "反射動作是否需要大腦參與？", answer: "大多數反射動作不涉及大腦，只通過脊髓或延髓完成。" },
      { question: "大腦的灰質和白質分布有何特點？", answer: "大腦灰質位於外層，主要是神經元細胞體；白質位於內層，主要是神經纖維。\n\n解釋: 灰質負責信息處理，白質負責信息傳遞。" },
      { question: "「神經」和「神經元」是同一樣東西嗎？", answer: "不是。\n\n解釋: 這是一個常見的混淆點。神經元是單一的神經細胞；而神經是由許多神經元的軸突（神經纖維）集結成束，外面由結締組織包裹而成的結構。可想像成：神經元是單一一條電線，而神經則是一整條電纜。" },
      { question: "運動神經元疾病為何通常不影響患者的感覺？", answer: "因為MND主要損害的是運動神經元。它們負責將指令從中樞神經系統傳到肌肉，控制活動。而負責傳遞感覺（如冷熱、觸碰）的感覺神經元是另一套獨立的神經元，不受此病影響。" },
      { question: "所有神經脈衝的傳遞方向都一樣嗎？", answer: "在單一神經元內，神經脈衝的傳遞是單向的。\n\n解釋: 由樹突接收，經細胞體，再沿軸突傳到末梢。這個單向性確保了信息傳遞的秩序和準確性。" },
      { question: "髓鞘的主要功能是提供營養嗎？", answer: "不是。 這是一個常見的誤解。髓鞘的主要功能有二：1)作為絕緣體，防止神經脈衝干擾到相鄰的神經纖維；2) 加快神經脈衝的傳遞速度。營養主要由血管提供。" },
      { question: "為甚麼神經脈衝在突觸的傳遞比在軸突上慢？", answer: "因為在突觸，信息需要從電訊號轉換為化學訊號，再轉換回電訊號。\n\n解釋: 這個過程涉及神經遞質的釋放、擴散穿過突觸間隙、再與下一個神經元的受體結合，需時較長。" },
      { question: "神經遞質釋放後會一直留在突觸間隙嗎？", answer: "不會。\n\n解釋: 若神經遞質持續作用，會導致神經元過度興奮或抑制。因此，它們會被特定的酶分解，或被突觸前神經元重新吸收，以終止信號。" },
      { question: "反射動作是否需要經過大腦思考？", answer: "不需要。\n\n解釋: 這是反射動作最大的特點。絕大部分反射動作的控制中樞位於脊髓或腦幹，目的是為了作出迅速、非自主的反應以保護身體，例如手碰到熱物體立即縮回。感覺會傳到大腦，但動作發生在大腦意識到之前。" },
      { question: "反射弧的五個組成部分是甚麼？", answer: "感受器→ 感覺神經元→ 中間神經元 → 運動神經元→ 效應器。\n\n解釋: 這是完成反射動作的完整通路。" },
      { question: "小腦的主要功能是思考嗎？", answer: "不是。\n\n解釋: 小腦主要負責協調肌肉活動、維持身體平衡和姿勢。思考、記憶、語言等高級認知功能主要由大腦負責。" },
      { question: "如果左大腦半球受損，會影響身體哪一邊的活動？", answer: "會影響身體的右半邊。\n\n解釋: 因為從大腦發出的神經通路在到達脊髓前會發生交叉（在腦幹位置），所以左腦控制右半身，右腦控制左半身。" },
      { question: "延髓為何如此重要？", answer: "延髓控制著許多維持生命的非自主活動中樞。\n\n解釋: 例如呼吸、心跳和血壓。因此，延髓的損傷往往是致命的。" },
      { question: "神經協調和激素協調，哪一個反應較快？", answer: "神經協調。\n\n解釋: 因為神經脈衝以電訊號形式沿著特定的神經纖維傳遞，速度極快。激素則需要通過血液循環運送到目標器官，速度相對慢得多。" },
      { question: "神經協調和激素協調，哪一個影響範圍較廣泛？", answer: "激素協調。\n\n解釋: 激素通過血液流遍全身，可以同時對多個目標器官產生影響，作用範圍通常比較廣泛和持久。神經協調的影響則較為集中和短暫。" },
      { question: "為甚麼說神經協調的反應是「短暫的」？", answer: "因為一旦刺激停止，神經脈衝的傳遞就會終止，神經遞質也會迅速被清除。\n\n解釋: 效應器的反應隨即停止。相反，激素需要時間被代謝和分解，所以其作用通常較為持久。" },
      { question: "阿茲海默氏症 (Alzheimer's disease) 主要影響大腦哪個區域的功能？", answer: "主要影響大腦皮層的聯合區。\n\n解釋: 特別是與記憶、思考和判斷相關的區域。隨著病情發展，神經元和它們之間的連接會逐漸喪失，導致認知功能嚴重衰退。" },
      { question: "為甚麼睡眠對鞏固記憶很重要？", answer: "科學研究表明，在睡眠期間，大腦會重播和整理白天的經歷。\n\n解釋: 這個過程有助於將短期記憶（儲存在海馬體）轉化和鞏固為長期記憶（儲存在大腦皮層）。缺乏充足睡眠會嚴重影響學習和記憶效率。" },
      { question: "神經元有哪三種類型？", answer: "感覺神經元、運動神經元和中間神經元。" },
      { question: "什麼是突觸？", answer: "突觸是神經元之間傳遞訊號的接觸點。\n\n解釋: 由前突觸神經元的軸突、突觸間隙和後突觸神經元的樹突組成。" },
      { question: "脊髓的作用是什麼？", answer: "脊髓傳遞腦與身體其他部位的訊號，並參與反射動作。" },
      { question: "反射動作為什麼重要？", answer: "它們能快速反應潛在危險。保護身體免受傷害。" },
      { question: "大腦的功能是什麼？", answer: "大腦負責思考、記憶和自願肌肉運動等功能，它是神經系統中最重要的器官。" },
      { question: "小腦控制什麼？", answer: "小腦協調肌肉運動、平衡和姿勢，確保動作的精確性和流暢性。" },
      { question: "延髓的作用是什麼？", answer: "延髓控制呼吸、心跳等基本生命功能" },
      { question: "激素與神經衝動有何不同？", answer: "激素是化學訊號，經血液傳遞；神經衝動是電訊號，沿神經元傳遞。\n\n解釋: 兩者是身體內兩種主要的通信方式。" }
    ]
    },
    {
      id: "CH17",
      title: "CH17 人體的運動",
    flashcards: [
      { question: "骨骼是活的組織嗎？", answer: "是的，骨骼是活的組織。它裡面含有活的骨細胞、血管和神經。因此，骨骼能夠生長、自我修復（例如骨折後的癒合），並對運動產生反應。" },
      { question: "骨和軟骨在獲取養分的方式上有何關鍵不同？", answer: "骨內有血管，能直接通過血液供應獲得養分和氧氣。軟骨內則沒有血管，它必須依賴周圍組織（例如關節中的滑液）的養分擴散來維持。" },
      { question: "除了支撐身體，脊柱內的椎間盤還有甚麼重要功能？", answer: "椎間盤由軟骨構成，它在脊柱中扮演著避震器的角色，能吸收和緩衝走路、跑跳時產生的衝擊力，同時也讓脊柱能有限度地彎曲。" },
      { question: "紅骨髓的主要功能是甚麼？它主要存在於哪種骨內？", answer: "紅骨髓的主要功能是製造血細胞（包括紅血細胞、白血細胞和血小板）。它主要存在於鬆質骨的孔隙中。" },
      { question: "將兩塊骨連接在一起的堅韌組織是甚麼？", answer: "是韌帶。它由堅韌而帶有彈性的纖維構成，作用是穩固關節，防止骨骼在活動時脫位。" },
      { question: "腱的功能又是甚麼？", answer: "肌腱的功能是將肌肉連接到骨骼上。它非常強韌但幾乎沒有彈性，能有效地將肌肉收縮的力量傳遞給骨骼，以產生動作。" },
      { question: "為何關節末端的骨頭要被一層光滑的軟骨覆蓋？", answer: "這層關節軟骨非常光滑，它可以在關節活動時大大減低骨頭之間的摩擦，並吸收震盪，作用就像一層保護墊。" },
      { question: "關節囊內的滑液有什麼作用？", answer: "滑液有兩個主要作用：一是潤滑關節，減少活動時的摩擦；二是為沒有血管供應的關節軟骨提供養分。" },
      { question: "肩關節和肘關節的活動方式有何不同？", answer: "肩關節是球窩關節，允許手臂在多個平面上自由轉動。肘關節是鉸鏈關節，結構上限制了手臂只能在單一平面上進行屈伸活動。" },
      { question: "肌肉收縮時，能否「推開」骨骼？", answer: "不能。骨骼肌只能通過「收縮」來「拉動」骨骼，而不能主動伸長來「推開」骨骼。因此，所有屈伸動作都需要一對作用相反的肌肉來配合完成。" },
      { question: "伸直手臂時，二頭肌和三頭肌分別處於甚麼狀態？", answer: "伸直手臂時，位於上臂後方的三頭肌會收縮而位於前方的二頭肌則會放鬆（拮抗肌的概念）。" },
      { question: "拮抗肌對（例如二頭肌和三頭肌）是怎樣協調工作的？", answer: "當其中一塊肌肉收縮以產生動作時，與它作用相反的另一塊肌肉必須同時放鬆，這樣才能使關節順利活動。" },
      { question: "隨意動作（如舉手）的指令最初從何而來？", answer: "指令最初來自於大腦的特定區域。大腦產生神經脈衝，通過神經系統傳遞到目標肌肉，觸發肌肉收縮，從而完成動作。" },
      { question: "運動時，小腦扮演了甚麼重要角色？", answer: "小腦是身體的「協調員」。它負責協調全身各組肌肉的活動，確保動作流暢、準確，並在運動中維持身體的平衡。" },
      { question: "我們能用意志控制所有肌肉的收縮嗎？", answer: "不能。我們只能控制附在骨骼上的骨骼肌，它們屬於隨意肌。而心肌和內臟的平滑肌則屬於不隨意肌，它們的活動不受我們的意志控制。" },
      { question: "骨骼系統的主要功能是什麼？", answer: "支撐身體、保護內臟、提供運動支點、儲存礦物質和製造血細胞。" },
      { question: "骨和軟骨有什麼不同？", answer: "骨含豐富礦物質，堅硬有血管；軟骨礦物質少，柔軟無血管。" },
      { question: "軟骨在人體中的主要作用是什麼？", answer: "減少骨骼摩擦、吸收震盪、提供支持如耳廓和氣管。" },
      { question: "椎間盤有什麼作用？", answer: "由軟骨組成，允許脊柱彎曲並吸收震盪。" },
      { question: "肋骨籃由哪些部分組成？", answer: "包括肋骨、胸骨和脊柱，保護心肺並協助呼吸。" },
      { question: "附肢骨骼中的帶有什麼功能？", answer: "如肩帶和腰帶，連接肢骨與中軸骨骼。" },
      { question: "什麼是關節？", answer: "兩塊或以上骨骼的連接處，分為活動和不動關節。" },
      { question: "活動關節和不動關節有什麼區別？", answer: "活動關節允許運動，如膝關節；不動關節固定，如顱骨縫。" },
      { question: "韌帶在關節中的作用是什麼？", answer: "連接骨骼，防止脫臼，同時保持靈活性。" },
      { question: "骨骼肌的特徵是什麼？", answer: "附著骨骼，受意識控制，具橫紋。" },
      { question: "平滑肌和心肌有什麼特點？", answer: "平滑肌在內臟，不受意識控制；心肌在心臟，自動收縮。" },
      { question: "神經肌肉接點的作用是什麼？", answer: "神經與肌肉的連接處，傳遞脈衝引發收縮。" },
      { question: "神經遞質如何影響肌肉？", answer: "從神經末梢釋放，刺激肌肉產生電脈衝引發收縮。" },
      { question: "屈肌和伸肌的作用有何不同？", answer: "屈肌使肢體彎曲，伸肌使肢體伸直。" },
      { question: "肌肉收縮如何帶動小腿抬升？", answer: "肌肉收縮產生拉力，經腱傳至小腿骨，使膝關節活動。" },
      { question: "韌帶在關節中扮演什麼角色？", answer: "連接骨與骨，固定關節位置，防止骨頭脫臼，同時允許關節活動。" },
      { question: "腱與韌帶有什麼不同？", answer: "腱將肌肉連接骨骼，無彈性，傳遞肌肉收縮力；韌帶連接骨與骨，有彈性，保護關節。" },
      { question: "二頭肌與三頭肌分別屬於哪種類型的肌肉？", answer: "二頭肌為屈肌，負責屈曲肢體；三頭肌為伸肌，負責伸展肢體。" },
      { question: "骨骼肌有什麼特點？", answer: "由多束肌纖維組成，呈橫紋狀，且受意識控制。" },
      { question: "骨骼肌收縮是如何被神經系統控制的？", answer: "運動神經元釋放神經遞質，刺激肌纖維產生電脈衝，引發肌肉收縮。" },
      { question: "神經肌肉接點是什麼？", answer: "運動神經元軸突與骨骼肌纖維的突觸，是神經信號傳遞至肌肉的地方。" },
      { question: "肌肉為何必須成對存在？", answer: "一組肌肉收縮帶動動作，另一組收縮恢復原位，確保運動靈活。" },
      { question: "肌肉收縮的神經傳導過程是？", answer: "神經脈衝到達運動神經末端，釋放神經遞質，神經遞質擴散穿越突觸間隙並與肌肉上的受體結合，刺激肌纖維產生電脈衝，引起收縮。" },
      { question: "電脈衝和神經脈衝是相同的嗎？", answer: "不是，電脈衝由肌肉產生，神經脈衝由神經元產生。" }
    ]
    },
    {
      id: "CH18",
      title: "CH18 體內平衡",
 flashcards: [
      { question: "什麼是體內平衡？", answer: "指身體維持內部環境穩定的過程，確保細胞能正常運作。" },
      { question: "為什麼需要維持體溫穩定？", answer: "體溫影響酶的活性，太高或太低都會干擾代謝。" },
      { question: "負反饋機制是如何運作的？", answer: "檢測到變化後，產生相反反應，將環境恢復正常。" },
      { question: "胰如何參與調節血糖？", answer: "檢測血糖變化，分泌胰島素或胰高血糖素調節血糖。" },
      { question: "胰島素如何降低血糖？", answer: "促進肝細胞和體細胞吸收葡萄糖，轉化成糖原。" },
      { question: "胰高血糖素如何升高血糖？", answer: "刺激肝細胞分解糖原，釋放葡萄糖到血液。" },
      { question: "肝在血糖調節中的角色是什麼？", answer: "儲存葡萄糖為糖原，或分解糖原釋放葡萄糖。" },
      { question: "血糖升高時身體怎麼反應？", answer: "胰分泌較多胰島素和較少胰高血糖素至血液中，肝和體細胞從血液吸收更多葡萄糖。" },
      { question: "血糖降低時身體怎麼反應？", answer: "胰分泌較多胰高血糖素和較少胰島素至血液中，刺激肝把糖原轉化為葡萄糖釋放到血液。" },
      { question: "第一型糖尿病是什麼原因引起的？", answer: "胰無法分泌足夠胰島素，通常是先天問題。" },
      { question: "第二型糖尿病是什麼原因引起的？", answer: "肝細胞對胰島素不敏感，導致血糖難以降。" },
      { question: "為什麼糖尿病患者尿中有葡萄糖？", answer: "血糖過高，腎臟無法全部重吸收。" },
      { question: "健康人士吃飯後血糖如何變化？糖尿病患者吃飯後血糖如何變化？", answer: "健康人士在飯後血糖短暫升高，胰島素作用下恢復正常。糖尿病患在飯後血糖升高更快更高，下降更慢。" },
      { question: "為什麼胰島素要注射而不能口服？", answer: "口服胰島素會被胃腸消化，失去作用。" },
      { question: "禁食時血糖如何維持穩定？", answer: "肝分解糖原，釋放葡萄糖到血液。" },
      { question: "高GI食物對血糖有什麼影響？", answer: "快速分解為葡萄糖，使血糖迅速上升。" },
      { question: "低GI食物有什麼好處？", answer: "食物緩慢釋放葡萄糖，減慢血糖的吸收，避免血糖水平急升至危險水平。" },
      { question: "什麼是負反饋機制？", answer: "系統感應參數偏離正常，啟動相反反應，將參數恢復至正常範圍。" },
      { question: "調定點是什麼？", answer: "體內某參數的理想或正常值範圍。" },
      { question: "血糖過高時，胰島素和胰高血糖素的分泌如何變化？", answer: "胰島素增加，胰高血糖素減少，促使血糖下降。" },
      { question: "血糖過低時，胰島素和胰高血糖素的分泌如何變化？", answer: "胰島素減少，胰高血糖素增加，促使血糖上升。" },
      { question: "糖尿病患者血糖調節異常的原因是什麼？", answer: "胰島素分泌不足或體細胞對胰島素敏感度降低。" },
      { question: "第一型糖尿病和第二型糖尿病有何不同？", answer: "第一型胰島素分泌不足；第二型體細胞胰島素敏感度降低。" },
      { question: "血糖水平過高對人體有何影響？", answer: "影響細胞代謝活動，長期可能損害多個器官。" },
      { question: "胰島素在血糖調節中的主要作用是甚麼？", answer: "降低血糖水平，主要通過刺激肝細胞和肌肉細胞把葡萄糖轉化為糖原。" },
      { question: "胰高血糖素在血糖調節中的主要作用是甚麼？", answer: "提升血糖水平，主要通過刺激肝細胞和肌肉細胞把糖原儲備轉化為葡萄糖。" },
      { question: "第一型糖尿病的主要成因是甚麼？", answer: "胰臟只能產生少量胰島素，或無法產生胰島素。" },
      { question: "為什麼在禁食後進行糖尿病檢查？", answer: "確保飲用的葡萄糖溶液是引致血糖水平變化的唯一因素。" },
      { question: "肝臟在血糖調節中扮演甚麼角色？", answer: "將葡萄糖轉化為糖原儲存，或將糖原轉化為葡萄糖釋放。" },
      { question: "第二型糖尿病的主要成因是甚麼？", answer: "體細胞對胰島素的敏感度低。" },
      { question: "為什麼糖原比葡萄糖更適合作為能量儲備？", answer: "糖原不溶於水，不會影響細胞的水勢。" },
      { question: "糖尿病患者如何通過飲食控制病情？", answer: "選擇低升糖指數的膳食，以減少血糖水平過高的機會。" }
    ]
    }
  ];
  // 狀態管理：每章節各自維護學習狀態
  const stateByChapter = {};
  function initChapterState(chapterId){
    const chapter = chapters.find(c=>c.id===chapterId);
    stateByChapter[chapterId] = {
      cardsWithWeights: chapter.flashcards.map(c => ({ ...c, weight: 1, hardCount: 0 })),
      currentIndex: 0, flipped: false, flipping: false, history: [0], historyPos: 0
    };
  }
  chapters.forEach(ch => initChapterState(ch.id));
  
  // 目前章節 & 主題
  let currentChapterId = "CH15";
  const themes = ['', 'theme-ocean-blue', 'theme-sunset-glow', 'theme-forest-green'];
  let currentThemeIndex = 0;

  // UI 元素
  const docElem = document.documentElement;
  const headerTitle = document.getElementById('headerTitle');
  const chapterInfo = document.getElementById('chapterInfo');
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const card = document.getElementById('card');
  const cardFront = document.getElementById('cardFront');
  const cardBack = document.getElementById('cardBack');
  const cardNumber = document.getElementById('cardNumber');
  const flipBtn = document.getElementById('flipBtn');
  const hardBtn = document.getElementById('hardBtn');
  const mediumBtn = document.getElementById('mediumBtn');
  const easyBtn = document.getElementById('easyBtn');
  const prevBtn = document.getElementById('prevBtn');
  const summaryBtn = document.getElementById('summaryBtn');
  const summaryBlock = document.getElementById('summaryBlock');
  const themeBtn = document.getElementById('themeBtn');

  function getChapter(){ return chapters.find(c=>c.id===currentChapterId); }
  function getState(){ return stateByChapter[currentChapterId]; }
  
  function updateHeader(){
    const ch = getChapter();
    headerTitle.textContent = ch.title;
    document.title = ch.title;
    chapterInfo.textContent = `目前章節：${ch.id}`;
  }
  
  function renderCard() {
    const cardContainer = document.querySelector('.card-container');
    cardContainer.style.animation = 'none';
    void cardContainer.offsetHeight; // 觸發瀏覽器重繪 (reflow)
    cardContainer.style.animation = '';

    const st = getState();
    st.flipped = false;
    card.classList.remove("flipped");
    card.setAttribute("aria-pressed", "false");
    const item = st.cardsWithWeights[st.currentIndex];
    cardFront.textContent = item.question;
    cardBack.textContent = item.answer;
    cardNumber.textContent = `卡片 ${st.currentIndex + 1} / ${st.cardsWithWeights.length}`;
    prevBtn.disabled = (st.historyPos <= 0);
    summaryBlock.hidden = true;
    summaryBlock.innerHTML = "";
  }
  
  function flipCard() {
    const st = getState();
    if (st.flipping) return;
    st.flipping = true;
    st.flipped = !st.flipped;
    card.classList.toggle("flipped", st.flipped);
    card.setAttribute("aria-pressed", st.flipped ? "true" : "false");
    setTimeout(() => { st.flipping = false; }, 600);
  }
  
  function updateWeight(difficulty) {
    const st = getState();
    const cardObj = st.cardsWithWeights[st.currentIndex];
    if (difficulty === "hard") { cardObj.weight += 2; cardObj.hardCount++; }
    else if (difficulty === "medium") { /* 不變 */ }
    else if (difficulty === "easy") { cardObj.weight = Math.max(1, cardObj.weight - 1); }
  }
  
  function weightedRandomIndex() {
    const st = getState();
    const totalWeight = st.cardsWithWeights.reduce((sum, c) => sum + c.weight, 0);
    if (totalWeight <= 0) return 0;
    let r = Math.random() * totalWeight;
    for (let i = 0; i < st.cardsWithWeights.length; i++) {
      r -= st.cardsWithWeights[i].weight;
      if (r < 0) return i;
    }
    return 0;
  }
  
  function nextCard(difficulty) {
    const st = getState();
    updateWeight(difficulty);
    const nextIdx = weightedRandomIndex();
    st.currentIndex = nextIdx;
    if (st.historyPos < st.history.length - 1) {
      st.history = st.history.slice(0, st.historyPos + 1);
    }
    st.history.push(st.currentIndex);
    st.historyPos++;
    renderCard();
    saveProgress();
  }
  
  function prevCard() {
    const st = getState();
    if (st.historyPos <= 0) return;
    st.historyPos--;
    st.currentIndex = st.history[st.historyPos];
    renderCard();
  }
  
  function showHardSummary() {
    const st = getState();
    let sortedCards = [...st.cardsWithWeights]
      .filter(c => c.hardCount > 0)
      .sort((a,b) => b.hardCount - a.hardCount)
      .slice(0,5);
    if (sortedCards.length === 0) {
      summaryBlock.innerHTML = "<h3>尚無標記為困難的題目</h3>";
      summaryBlock.hidden = false;
      return;
    }
    let html = "<h3>困難題目小結（前5題）</h3>";
    sortedCards.forEach((c,i) => {
      html += `<div class="summary-item">
        <p><strong>題目 ${i + 1}：</strong>${c.question}</p>
        <p><strong>答案：</strong>${c.answer}</p>
        <p><strong>困難標記次數：</strong>${c.hardCount}</p>
      </div>`;
    });
    summaryBlock.innerHTML = html;
    summaryBlock.hidden = false;
  }
  
  function switchChapter(newId){
    if (newId === currentChapterId) return;
    tabs.forEach(t=>{
      const active = t.dataset.chapter === newId;
      t.classList.toggle('active', active);
      t.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
    currentChapterId = newId;
    updateHeader();
    renderCard();
    card.focus();
    saveProgress(); 
  }
  
 // =================================================
// 初始設定與渲染
// =================================================

loadProgressAndSettings(); // <-- 新增：在渲染前，先讀取儲存的進度與設定
  updateHeader();
  renderCard();
  
  // 事件綁定
  flipBtn.addEventListener("click", flipCard);
  hardBtn.addEventListener("click", () => { const st = getState(); if (!st.flipped) flipCard(); nextCard("hard"); });
  mediumBtn.addEventListener("click", () => { const st = getState(); if (!st.flipped) flipCard(); nextCard("medium"); });
  easyBtn.addEventListener("click", () => { const st = getState(); if (!st.flipped) flipCard(); nextCard("easy"); });
  prevBtn.addEventListener("click", prevCard);
  summaryBtn.addEventListener("click", showHardSummary);
  
  themeBtn.addEventListener('click', () => {
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    const newTheme = themes[currentThemeIndex];
    docElem.className = newTheme;
    saveProgress();
  });

  document.addEventListener("keydown", (e) => {
    if ((e.code === "Space" || e.key === " ") && document.activeElement === card) {
      e.preventDefault(); flipCard(); return;
    }
    if (e.key === "1") { const st=getState(); if(!st.flipped) flipCard(); nextCard("hard"); }
    if (e.key === "2") { const st=getState(); if(!st.flipped) flipCard(); nextCard("medium"); }
    if (e.key === "3") { const st=getState(); if(!st.flipped) flipCard(); nextCard("easy"); }
    if (e.key === "ArrowLeft") { prevCard(); }
    if (e.key?.toLowerCase?.() === "s") { showHardSummary(); }
  });
  
  card.addEventListener('click', flipCard);
  tabs.forEach(tab => tab.addEventListener('click', () => switchChapter(tab.dataset.chapter)));
  
  // 為了簡化，我移除了之前版本中 chapters 資料的省略部分，將完整的資料放入
  // 這確保了程式碼的完整性和可運行性
</script>
</body>
</html>

